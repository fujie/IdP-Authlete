<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federation Test Client 2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h1 class="h3 mb-0">❌ Federation Test Client 2 (Invalid Trust Chain)</h1>
                    </div>
                    <div class="card-body">
                        <% if (user && user.authenticated) { %>
                            <!-- This should not happen -->
                            <div class="alert alert-warning">
                                <h4>⚠️ 予期しない状態</h4>
                                <p>このクライアントは無効なTrust Chainを持っているため、認証に成功すべきではありません。</p>
                            </div>
                        <% } else { %>
                            <!-- Expected State -->
                            <div class="alert alert-warning">
                                <h4>OpenID Federation Test Client 2</h4>
                                <p>このクライアントは <strong>無効なTrust Chain</strong> を持っており、動的登録が失敗するはずです。</p>
                            </div>

                            <!-- Federation Configuration -->
                            <h5>Federation 設定</h5>
                            <ul class="list-group mb-3">
                                <li class="list-group-item"><strong>Entity ID:</strong> <%= config.entityId %></li>
                                <li class="list-group-item"><strong>クライアント名:</strong> <%= config.clientName %></li>
                                <li class="list-group-item"><strong>認可サーバー:</strong> <%= config.authorizationServer %></li>
                                <li class="list-group-item"><strong>Trust Chain状態:</strong> 
                                    <span class="badge bg-danger">❌ <%= config.trustChainStatus %></span>
                                </li>
                                <li class="list-group-item"><strong>Trust Anchor:</strong> <%= config.trustAnchor %></li>
                            </ul>

                            <!-- Dynamic Registration Status -->
                            <h5>動的登録状態</h5>
                            <% if (clientRegistration) { %>
                                <!-- This should not happen -->
                                <div class="alert alert-danger">
                                    <h6>❌ 予期しない成功</h6>
                                    <p>このクライアントの動的登録が成功しましたが、無効なTrust Chainのため失敗すべきでした。</p>
                                    <ul class="mb-0">
                                        <li><strong>Client ID:</strong> <%= clientRegistration.client_id %></li>
                                        <li><strong>登録日時:</strong> <%= new Date(clientRegistration.client_id_issued_at * 1000).toLocaleString() %></li>
                                    </ul>
                                </div>
                            <% } else if (registrationError) { %>
                                <!-- Expected behavior -->
                                <div class="alert alert-success">
                                    <h6>✅ 期待通りの動作: 動的登録失敗</h6>
                                    <p>無効なTrust Chainのため、動的登録が正しく拒否されました。</p>
                                    <ul class="mb-0">
                                        <li><strong>エラー:</strong> <%= registrationError.error %></li>
                                        <li><strong>説明:</strong> <%= registrationError.error_description %></li>
                                        <% if (registrationError.trust_chain_validation) { %>
                                            <li><strong>Trust Chain検証:</strong> 
                                                <span class="badge bg-danger">❌ <%= registrationError.trust_chain_validation.error %></span>
                                            </li>
                                        <% } %>
                                    </ul>
                                </div>
                                
                                <div class="alert alert-info">
                                    <h6>📋 テスト結果</h6>
                                    <p>このクライアントは設計通りに動作しています：</p>
                                    <ul class="mb-0">
                                        <li>✅ Request Object: 作成・送信可能</li>
                                        <li>✅ Trust Chain検証が失敗</li>
                                        <li>✅ 動的登録が拒否</li>
                                        <li>✅ 認証フローに進めない</li>
                                    </ul>
                                </div>
                                
                                <div class="d-grid gap-2 mb-3">
                                    <a href="/login" class="btn btn-warning btn-lg">⚠️ Federation ログイン試行 (Request Object - 失敗予定)</a>
                                </div>
                            <% } else { %>
                                <div class="alert alert-warning">
                                    <h6>⏳ 動的登録処理中...</h6>
                                    <p>Trust Chain検証と動的登録を実行中です（失敗が期待されます）。</p>
                                </div>
                                
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-primary" onclick="location.reload()">🔄 状態を更新</button>
                                </div>
                            <% } %>

                            <!-- Federation Discovery -->
                            <h5>Federation Discovery</h5>
                            <div class="d-grid gap-2 mb-3">
                                <a href="<%= config.entityId.replace('https://', 'http://') %>/.well-known/openid-federation" target="_blank" class="btn btn-outline-primary">
                                    📄 このクライアントの Entity Configuration
                                </a>
                                <a href="<%= config.authorizationServer %>/.well-known/openid-federation" target="_blank" class="btn btn-outline-info">
                                    OP Entity Configuration を確認
                                </a>
                                <a href="<%= config.authorizationServer %>/.well-known/openid-configuration" target="_blank" class="btn btn-outline-info">
                                    OpenID Connect Discovery を確認
                                </a>
                            </div>

                            <div class="mt-4">
                                <h6>Federation テストフロー (Request Object):</h6>
                                <ol class="small">
                                    <li><strong>Request Object作成:</strong> クライアントがJWT形式のRequest Objectを作成</li>
                                    <li><strong>認証要求:</strong> Request Objectを含む認証要求をOPに送信</li>
                                    <li><strong>Trust Chain検証:</strong> OPがクライアントのTrust Chainを検証</li>
                                    <li><strong>動的登録拒否:</strong> Trust Chain無効のため、登録を拒否</li>
                                    <li><strong>認証フロー停止:</strong> 登録されていないため認証不可</li>
                                </ol>
                                
                                <h6>期待される結果:</h6>
                                <ul class="small text-danger">
                                    <li>✅ Request Object: 正常に作成・送信</li>
                                    <li>❌ Trust Chain検証: 失敗 (無効なTrust Chainを持つ)</li>
                                    <li>❌ 動的登録: 拒否</li>
                                    <li>❌ 認証フロー: 実行不可</li>
                                </ul>
                            </div>
                        <% } %>
                    </div>
                </div>

                <div class="mt-3 text-center">
                    <small class="text-muted">
                        Federation Test Client 2 (Invalid Trust Chain) | 
                        <a href="/health" target="_blank">Health Check</a>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>