<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federation Test Client 1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h1 class="h3 mb-0">ğŸ”— Federation Test Client 1 (Valid Trust Chain)</h1>
                    </div>
                    <div class="card-body">
                        <% if (user && user.authenticated) { %>
                            <!-- Authenticated State -->
                            <div class="alert alert-success">
                                <h4>âœ… Federation èªè¨¼æˆåŠŸ!</h4>
                                <p>OpenID Federation ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚</p>
                            </div>

                            <h5>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h5>
                            <ul class="list-group mb-3">
                                <li class="list-group-item"><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> <%= user.id %></li>
                                <li class="list-group-item"><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> <%= user.name %></li>
                                <li class="list-group-item"><strong>èªè¨¼çŠ¶æ…‹:</strong> <%= user.authenticated ? 'èªè¨¼æ¸ˆã¿' : 'æœªèªè¨¼' %></li>
                            </ul>

                            <% if (accessToken) { %>
                                <h5>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±</h5>
                                <div class="mb-3">
                                    <label class="form-label">ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³:</label>
                                    <textarea class="form-control" rows="3" readonly><%= accessToken %></textarea>
                                </div>
                            <% } %>

                            <% if (idToken) { %>
                                <h5>IDãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±</h5>
                                <div class="mb-3">
                                    <label class="form-label">IDãƒˆãƒ¼ã‚¯ãƒ³:</label>
                                    <textarea class="form-control" rows="4" readonly><%= idToken %></textarea>
                                </div>
                            <% } %>

                            <div class="d-grid gap-2">
                                <a href="/api-test" class="btn btn-primary">API ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</a>
                                <a href="/logout" class="btn btn-outline-secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                            </div>

                        <% } else { %>
                            <!-- Unauthenticated State -->
                            <div class="alert alert-info">
                                <h4>OpenID Federation Test Client 1</h4>
                                <p>ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ <strong>æœ‰åŠ¹ãªTrust Chain</strong> ã‚’æŒã£ã¦ãŠã‚Šã€å‹•çš„ç™»éŒ²ãŒæˆåŠŸã™ã‚‹ã¯ãšã§ã™ã€‚</p>
                            </div>

                            <!-- Federation Configuration -->
                            <h5>Federation è¨­å®š</h5>
                            <ul class="list-group mb-3">
                                <li class="list-group-item"><strong>Entity ID:</strong> <%= config.entityId %></li>
                                <li class="list-group-item"><strong>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå:</strong> <%= config.clientName %></li>
                                <li class="list-group-item"><strong>èªå¯ã‚µãƒ¼ãƒãƒ¼:</strong> <%= config.authorizationServer %></li>
                                <li class="list-group-item"><strong>Trust ChainçŠ¶æ…‹:</strong> 
                                    <span class="badge bg-success">âœ… <%= config.trustChainStatus %></span>
                                </li>
                                <li class="list-group-item"><strong>Trust Anchor:</strong> <%= config.trustAnchor %></li>
                            </ul>

                            <!-- Dynamic Registration Status -->
                            <h5>å‹•çš„ç™»éŒ²çŠ¶æ…‹</h5>
                            <% if (clientRegistration) { %>
                                <div class="alert alert-success">
                                    <h6>âœ… å‹•çš„ç™»éŒ²æˆåŠŸ</h6>
                                    <ul class="mb-0">
                                        <li><strong>Client ID:</strong> <%= clientRegistration.client_id %></li>
                                        <li><strong>ç™»éŒ²æ—¥æ™‚:</strong> <%= new Date(clientRegistration.client_id_issued_at * 1000).toLocaleString() %></li>
                                        <li><strong>Trust Chainæ¤œè¨¼:</strong> 
                                            <span class="badge bg-success">âœ… Valid</span>
                                        </li>
                                        <li><strong>Trust Anchor:</strong> <%= clientRegistration.trust_chain_validation.trustAnchor %></li>
                                    </ul>
                                </div>
                                
                                <div class="d-grid gap-2 mb-3">
                                    <a href="/login" class="btn btn-success btn-lg">ğŸ”— Federation ãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹ (Request Object)</a>
                                </div>
                            <% } else if (registrationError) { %>
                                <div class="alert alert-danger">
                                    <h6>âŒ å‹•çš„ç™»éŒ²å¤±æ•—</h6>
                                    <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> <%= registrationError.error %></p>
                                    <p><strong>èª¬æ˜:</strong> <%= registrationError.error_description %></p>
                                    <% if (registrationError.trust_chain_validation) { %>
                                        <p><strong>Trust Chainæ¤œè¨¼:</strong> 
                                            <span class="badge bg-danger">âŒ <%= registrationError.trust_chain_validation.error %></span>
                                        </p>
                                    <% } %>
                                </div>
                                
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-warning" onclick="location.reload()">ğŸ”„ å†è©¦è¡Œ</button>
                                </div>
                            <% } else { %>
                                <div class="alert alert-warning">
                                    <h6>â³ å‹•çš„ç™»éŒ²å‡¦ç†ä¸­...</h6>
                                    <p>Trust Chainæ¤œè¨¼ã¨å‹•çš„ç™»éŒ²ã‚’å®Ÿè¡Œä¸­ã§ã™ã€‚</p>
                                </div>
                                
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-primary" onclick="location.reload()">ğŸ”„ çŠ¶æ…‹ã‚’æ›´æ–°</button>
                                </div>
                            <% } %>

                            <!-- Federation Discovery -->
                            <h5>Federation Discovery</h5>
                            <div class="d-grid gap-2 mb-3">
                                <a href="<%= config.entityId.replace('https://', 'http://') %>/.well-known/openid-federation" target="_blank" class="btn btn-outline-primary">
                                    ğŸ“„ ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® Entity Configuration
                                </a>
                                <a href="<%= config.authorizationServer %>/.well-known/openid-federation" target="_blank" class="btn btn-outline-info">
                                    OP Entity Configuration ã‚’ç¢ºèª
                                </a>
                                <a href="<%= config.authorizationServer %>/.well-known/openid-configuration" target="_blank" class="btn btn-outline-info">
                                    OpenID Connect Discovery ã‚’ç¢ºèª
                                </a>
                            </div>

                            <div class="mt-4">
                                <h6>Federation ãƒ†ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ (Request Object):</h6>
                                <ol class="small">
                                    <li><strong>Request Objectä½œæˆ:</strong> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒJWTå½¢å¼ã®Request Objectã‚’ä½œæˆ</li>
                                    <li><strong>èªè¨¼è¦æ±‚:</strong> Request Objectã‚’å«ã‚€èªè¨¼è¦æ±‚ã‚’OPã«é€ä¿¡</li>
                                    <li><strong>Trust Chainæ¤œè¨¼:</strong> OPãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®Trust Chainã‚’æ¤œè¨¼</li>
                                    <li><strong>å‹•çš„ç™»éŒ²:</strong> Trust Chainæœ‰åŠ¹ãªå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å‹•çš„ç™»éŒ²</li>
                                    <li><strong>èªè¨¼ãƒ•ãƒ­ãƒ¼:</strong> é€šå¸¸ã®OpenID Connectèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ</li>
                                    <li><strong>ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—:</strong> ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—</li>
                                    <li><strong>APIå‘¼ã³å‡ºã—:</strong> å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã§APIå‘¼ã³å‡ºã—ã‚’ãƒ†ã‚¹ãƒˆ</li>
                                </ol>
                                
                                <h6>æœŸå¾…ã•ã‚Œã‚‹çµæœ:</h6>
                                <ul class="small text-success">
                                    <li>âœ… Request Object: æ­£å¸¸ã«ä½œæˆãƒ»é€ä¿¡</li>
                                    <li>âœ… Trust Chainæ¤œè¨¼: æˆåŠŸ (æœ‰åŠ¹ãªTrust Chainã‚’æŒã¤)</li>
                                    <li>âœ… å‹•çš„ç™»éŒ²: æˆåŠŸ</li>
                                    <li>âœ… èªè¨¼ãƒ•ãƒ­ãƒ¼: æˆåŠŸ</li>
                                </ul>
                            </div>
                        <% } %>
                    </div>
                </div>

                <div class="mt-3 text-center">
                    <small class="text-muted">
                        Federation Test Client 1 (Valid Trust Chain) | 
                        <a href="/health" target="_blank">Health Check</a>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>